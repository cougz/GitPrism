---
import Layout from '../layouts/Layout.astro';
---
<Layout title="GitPrism">
  <style>
    /* ── Page layout ── */
    .page {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 0 24px;
    }

    /* ── Hero ── */
    .hero {
      text-align: center;
      padding: 80px 0 40px;
      max-width: 680px;
      width: 100%;
    }
    .hero-title {
      font-size: 2.8rem;
      font-weight: 700;
      line-height: 1.15;
      margin-bottom: 16px;
      background: linear-gradient(135deg, #ffffff 0%, var(--cf-orange-light) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .hero-subtitle {
      font-size: 1rem;
      color: var(--text-secondary);
      line-height: 1.6;
      max-width: 480px;
      margin: 0 auto;
    }

    /* ── Search bar ── */
    .search-section {
      width: 100%;
      max-width: 720px;
      margin-bottom: 16px;
    }
    .search-bar {
      display: flex;
      align-items: center;
      background: var(--bg-secondary);
      border: 2px solid var(--border-color);
      border-radius: 14px;
      padding: 6px 6px 6px 20px;
      gap: 8px;
      transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
    }
    .search-bar:focus-within {
      border-color: var(--cf-orange);
      box-shadow: 0 0 0 3px rgba(244, 128, 36, 0.12);
    }
    .search-icon {
      flex-shrink: 0;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
    }
    .search-input {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      color: var(--text-primary);
      font-family: var(--font-mono);
      font-size: 14px;
      line-height: 1.5;
      padding: 8px 0;
      min-width: 0;
    }
    .search-input::placeholder {
      color: var(--text-muted);
      font-family: var(--font-sans);
    }
    .search-btn {
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      background: var(--cf-orange);
      color: white;
      border: none;
      border-radius: 10px;
      padding: 10px 20px;
      font-family: var(--font-sans);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      transition: background var(--transition-fast), transform var(--transition-fast);
    }
    .search-btn:hover:not(:disabled) {
      background: var(--cf-orange-dark);
      transform: translateY(-1px);
    }
    .search-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .spinner {
      display: none;
      width: 14px; height: 14px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ── Detail level pills ── */
    .options-row {
      width: 100%;
      max-width: 720px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }
    .options-label {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      white-space: nowrap;
    }
    .pills {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .pill {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 5px 12px;
      border-radius: 20px;
      border: 1px solid var(--border-color);
      background: var(--bg-secondary);
      color: var(--text-secondary);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition-fast);
      user-select: none;
    }
    .pill:hover {
      border-color: var(--cf-orange);
      color: var(--cf-orange);
    }
    .pill.active {
      border-color: var(--cf-orange);
      background: rgba(244, 128, 36, 0.1);
      color: var(--cf-orange);
    }
    .pill input[type="radio"] { display: none; }

    /* ── Error banner ── */
    .error-banner {
      display: none;
      width: 100%;
      max-width: 720px;
      background: rgba(248, 81, 73, 0.1);
      border: 1px solid #f85149;
      border-radius: var(--radius-md);
      color: #f85149;
      font-size: 13px;
      padding: 10px 16px;
      margin-bottom: 8px;
    }

    /* ── Result section ── */
    .result-section {
      display: none;
      width: 100%;
      max-width: 960px;
      margin-bottom: 60px;
    }
    .result-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      gap: 12px;
      flex-wrap: wrap;
    }
    .result-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
    }
    .result-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--text-secondary);
      flex-wrap: wrap;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 600;
    }
    .badge-hit     { background: rgba(63, 185, 80, 0.15);  color: #3fb950; }
    .badge-miss    { background: rgba(210, 153, 34, 0.15); color: #d29922; }
    .badge-trunc   { background: rgba(248, 81, 73, 0.12);  color: #f85149; }
    .result-actions {
      display: flex;
      gap: 8px;
    }
    .btn-sm {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      font-family: var(--font-sans);
      font-size: 12px;
      font-weight: 500;
      padding: 6px 14px;
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    .btn-sm:hover { border-color: var(--cf-orange); color: var(--cf-orange); }

    .result-viewer {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      overflow: auto;
      max-height: 68vh;
    }
    .result-viewer pre {
      padding: 20px;
      margin: 0;
      white-space: pre-wrap;
      word-break: break-word;
      line-height: 1.65;
      color: var(--text-primary);
      font-size: 13px;
    }

    /* ── Footer ── */
    footer {
      margin-top: auto;
      padding: 24px 0 32px;
      text-align: center;
      color: var(--text-secondary);
      font-size: 12px;
    }
    footer a { color: var(--text-secondary); }
    footer a:hover { color: var(--cf-orange); }
    footer code {
      background: var(--bg-secondary);
      padding: 1px 5px;
      border-radius: 3px;
      font-size: 11px;
    }
    .footer-github {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      vertical-align: middle;
    }
    .footer-github svg {
      width: 14px;
      height: 14px;
      vertical-align: middle;
    }

    /* ── Mode hints ── */
    .mode-hints-container {
      margin-bottom: 24px;
    }
    .mode-hints-label {
      text-align: center;
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 12px;
    }
    .mode-hints {
      display: flex;
      gap: 12px;
      margin-bottom: 40px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .mode-hint {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 10px 16px;
      font-size: 12px;
      color: var(--text-secondary);
      line-height: 1.5;
    }
    .mode-hint strong { color: var(--cf-orange); display: block; margin-bottom: 2px; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em; }

    /* ── Interactive label ── */
    .interactive-label {
      text-align: center;
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 32px 0 16px;
      padding: 0 20px;
    }

    /* ── Powered by ── */
    .powered-by {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 0.85em;
      color: var(--text-muted);
    }
    .cf-workers-icon {
      color: var(--cf-orange);
      vertical-align: text-bottom;
    }
    .powered-by a {
      color: var(--cf-orange);
      font-weight: 500;
    }

    /* ── Responsive ── */
    @media (max-width: 600px) {
      .hero { padding: 56px 0 32px; }
      .hero-title { font-size: 2rem; }
      .interactive-label { font-size: 1rem; margin: 24px 0 12px; }
      .search-bar { border-radius: 10px; padding: 4px 4px 4px 14px; }
      .search-btn { padding: 9px 14px; font-size: 13px; }
      .mode-hints { gap: 8px; }
      .result-header { flex-direction: column; align-items: flex-start; }
    }
  </style>

  <main class="page">
    <!-- Hero -->
    <section class="hero">
      <h1 class="hero-title">Welcome to GitPrism</h1>
      <p class="hero-subtitle">
        Convert any public GitHub repository into LLM-ready Markdown — instantly, via web, REST API, or MCP tool.
        <br>
        <span class="powered-by">
          Powered by
          <svg viewBox="0 0 50 50" width="18" height="18" fill="currentColor" aria-hidden="true" class="cf-workers-icon">
            <path d="m18.63 37.418-9.645-12.9 9.592-12.533-1.852-2.527L5.917 23.595l-.015 1.808 10.86 14.542z"></path>
            <path d="M21.997 6.503h-3.712l13.387 18.3-13.072 17.7h3.735L35.4 24.81z"></path>
            <path d="M29.175 6.503h-3.758l13.598 18.082-13.598 17.918h3.765l12.908-17.01v-1.808z"></path>
          </svg>
          <a href="https://developers.cloudflare.com/workers/" target="_blank" rel="noopener">Cloudflare Workers</a>
        </span>
      </p>
    </section>

    <!-- Interactive label -->
    <div class="interactive-label">Or use interactively here</div>

    <!-- Search bar -->
    <section class="search-section">
      <form id="ingest-form">
        <div class="search-bar">
          <span class="search-icon">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
            </svg>
          </span>
          <input
            type="text"
            id="repo-url"
            class="search-input"
            placeholder="https://github.com/owner/repo  or  https://github.com/owner/repo/tree/main/src"
            autocomplete="off"
            spellcheck="false"
            required
          />
          <button type="submit" class="search-btn" id="submit-btn">
            <span class="spinner" id="spinner"></span>
            <span id="submit-label">Ingest</span>
          </button>
        </div>
      </form>
    </section>

    <!-- Mode hints -->
    <div class="mode-hints-container">
      <div class="mode-hints-label">Other Usage Options</div>
      <div class="mode-hints" id="mode-hints">
        <div class="mode-hint">
          <strong>REST API</strong>
          <code>/ingest?repo=owner/repo&amp;summary</code>
        </div>
        <div class="mode-hint">
          <strong>URL Proxy</strong>
          <code>/https://github.com/owner/repo?file-list</code>
        </div>
        <div class="mode-hint">
          <strong>MCP Tool</strong>
          <code>/mcp</code> · <code>ingest_repo(url, detail)</code>
        </div>
      </div>
    </div>

    <!-- Detail level options -->
    <div class="options-row">
      <span class="options-label">Detail:</span>
      <div class="pills" id="detail-pills">
        <label class="pill"><input type="radio" name="detail" value="summary" /> Summary</label>
        <label class="pill"><input type="radio" name="detail" value="structure" /> Structure</label>
        <label class="pill"><input type="radio" name="detail" value="file-list" /> File List</label>
        <label class="pill active"><input type="radio" name="detail" value="full" checked /> Full</label>
      </div>
    </div>

    <!-- Error banner -->
    <div class="error-banner" id="error-banner"></div>

    <!-- Result -->
    <section class="result-section" id="result-section">
      <div class="result-header">
        <div>
          <div class="result-title" id="result-title">Output</div>
          <div class="result-meta" id="result-meta"></div>
        </div>
        <div class="result-actions">
          <button class="btn-sm" id="copy-btn">Copy</button>
          <button class="btn-sm" id="download-btn">Download .md</button>
        </div>
      </div>
      <div class="result-viewer">
        <pre id="result-content"></pre>
      </div>
    </section>

    <!-- Footer -->
     <footer>
       <p>
         GitPrism &nbsp;·&nbsp;
         <a href="/llms.txt">llms.txt</a>
         &nbsp;·&nbsp;
         MCP: <code>/mcp</code>
         &nbsp;·&nbsp;
         API: <code>/ingest?repo=owner/repo</code>
         &nbsp;·&nbsp;
         Proxy: <code>/https://github.com/owner/repo</code>
         &nbsp;·&nbsp;
         <a href="https://github.com/cougz/GitPrism" target="_blank" rel="noopener" class="footer-github" aria-label="GitHub repository">
           <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
             <path d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z"/>
           </svg>
           GitHub
         </a>
       </p>
     </footer>
  </main>

  <script>
    // ── Detail pills ──────────────────────────────────────────────────────────
    document.querySelectorAll('.pill').forEach(pill => {
      pill.addEventListener('click', () => {
        document.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
        pill.classList.add('active');
      });
    });

    function getSelectedDetail(): string {
      const checked = document.querySelector<HTMLInputElement>('.pill input[type="radio"]:checked');
      return checked?.value ?? 'full';
    }

    // ── Build API URL ─────────────────────────────────────────────────────────
    function buildApiUrl(repoInput: string, detail: string): string {
      const raw = repoInput.trim();

      // Full GitHub URL — use URL-proxy shorthand so ref/subpath are preserved
      if (raw.startsWith('https://github.com/') || raw.startsWith('http://github.com/')) {
        const params = new URLSearchParams();
        params.set('detail', detail);
        return `/${raw}?${params.toString()}`;
      }

      // owner/repo shorthand or any other form — use canonical /ingest
      const params = new URLSearchParams();
      params.set('repo', raw);
      params.set('detail', detail);
      return `/ingest?${params.toString()}`;
    }

    // ── Form submission ───────────────────────────────────────────────────────
    const form        = document.getElementById('ingest-form') as HTMLFormElement;
    const input       = document.getElementById('repo-url') as HTMLInputElement;
    const submitBtn   = document.getElementById('submit-btn') as HTMLButtonElement;
    const spinner     = document.getElementById('spinner') as HTMLElement;
    const submitLabel = document.getElementById('submit-label') as HTMLElement;
    const errorBanner = document.getElementById('error-banner') as HTMLElement;
    const resultSec   = document.getElementById('result-section') as HTMLElement;
    const resultTitle = document.getElementById('result-title') as HTMLElement;
    const resultMeta  = document.getElementById('result-meta') as HTMLElement;
    const resultPre   = document.getElementById('result-content') as HTMLElement;
    const modeHints   = document.getElementById('mode-hints') as HTMLElement;

    let lastContent = '';
    let lastLabel   = '';

    function setLoading(on: boolean) {
      submitBtn.disabled = on;
      spinner.style.display = on ? 'block' : 'none';
      submitLabel.textContent = on ? 'Loading…' : 'Ingest';
    }

    function showError(msg: string) {
      errorBanner.textContent = msg;
      errorBanner.style.display = 'block';
    }

    function hideError() {
      errorBanner.style.display = 'none';
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      hideError();

      const raw = input.value.trim();
      if (!raw) return;

      const detail  = getSelectedDetail();
      const apiUrl  = buildApiUrl(raw, detail);

      setLoading(true);
      resultSec.style.display  = 'none';

      try {
        const res = await fetch(apiUrl);

        if (!res.ok) {
          let msg = `Request failed (HTTP ${res.status})`;
          try {
            const body = await res.json() as { error?: string };
            if (body.error) msg = body.error;
          } catch { /* ignore parse error */ }

          if (res.status === 413) msg = 'This repository is too large. Try adding /tree/branch/subdirectory to scope results.';
          else if (res.status === 429) {
            const ra = res.headers.get('Retry-After');
            msg = `Rate limit reached. Please try again${ra ? ` in ${ra} seconds` : ' later'}.`;
          } else if (res.status === 404) msg = 'Repository not found. It may be private or the URL is misspelled.';

          showError(msg);
          return;
        }

        const text = await res.text();
        lastContent = text;

        // Derive a short label
        try {
          const m = raw.match(/github\.com\/([^/]+\/[^/]+)/);
          lastLabel = m ? m[1] : raw.split('/').slice(-2).join('/');
        } catch { lastLabel = 'output'; }

        // Display result
        resultPre.textContent = text;
        resultTitle.textContent = lastLabel;

        // Metadata from response headers
        const fileCount = res.headers.get('X-File-Count');
        const totalSize = res.headers.get('X-Total-Size');
        const truncated = res.headers.get('X-Truncated');
        const cacheStatus = res.headers.get('X-Cache');

        let metaHtml = '';
        if (fileCount) metaHtml += `<span>${fileCount} files</span>`;
        if (totalSize) {
          const bytes = parseInt(totalSize);
          const sizeStr = bytes < 1024 * 1024
            ? `${(bytes / 1024).toFixed(1)} KB`
            : `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
          metaHtml += `<span>${sizeStr}</span>`;
        }
        if (cacheStatus) {
          const cls = cacheStatus === 'HIT' ? 'badge-hit' : 'badge-miss';
          metaHtml += `<span class="badge ${cls}">${cacheStatus}</span>`;
        }
        if (truncated === 'true') {
          metaHtml += `<span class="badge badge-trunc">TRUNCATED</span>`;
        }
        resultMeta.innerHTML = metaHtml;
        resultSec.style.display = 'block';
        resultSec.scrollIntoView({ behavior: 'smooth', block: 'start' });

      } catch {
        showError('Network error. Check your connection and try again.');
      } finally {
        setLoading(false);
      }
    });

    // ── Copy ──────────────────────────────────────────────────────────────────
    document.getElementById('copy-btn')?.addEventListener('click', async () => {
      if (!lastContent) return;
      try {
        await navigator.clipboard.writeText(lastContent);
        const btn = document.getElementById('copy-btn') as HTMLButtonElement;
        btn.textContent = 'Copied!';
        setTimeout(() => { btn.textContent = 'Copy'; }, 2000);
      } catch { /* ignore */ }
    });

    // ── Download ──────────────────────────────────────────────────────────────
    document.getElementById('download-btn')?.addEventListener('click', () => {
      if (!lastContent) return;
      const blob = new Blob([lastContent], { type: 'text/markdown' });
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement('a');
      a.href     = url;
      a.download = `${lastLabel.replace('/', '-') || 'output'}.md`;
      a.click();
      URL.revokeObjectURL(url);
    });
  </script>
</Layout>
